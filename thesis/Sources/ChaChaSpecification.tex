%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{ChaCha Specification}
\label{chap:chacha}

To help with understanding the plugin visualization and for the sake of completeness, I will summarize the specification of the ChaCha cipher in this chapter.

ChaCha is a 256-bit stream cipher based on Salsa20, both developed by Prof. Daniel J. Bernstein. It was designed to improve diffusion per round while maintaining or even increasing the performance compared to Salsa20. This makes it more secure than Salsa20 with the same amount of rounds. It was developed in the year 2008, 3 years after Salsa20 \cite{chachaspec}.

The specification can be broken apart into three main points: \\
The \textit{quarterround} function, the \textit{littleendian} function and the hash function which utilizes the two other mentioned functions. I will start with the quarterround function.

\section{Quarterround function}
\label{sec:chacha.qr}

The ChaCha quarterround function takes in four 32-bit unsigned integers which we will name $a$, $b$, $c$ and $d$. It also returns four 32-bit unsigned integers.\\
It modifies its input values as described in the following pseudo-code:

\begin{center}
\begin{minipage}{0.5\linewidth}
\texttt{quarterround(a,b,c,d):} \\
\hspace*{1em}\texttt{a += b; d  \^{}= a; d} \verb|<<<|\texttt{= 16;} \\
\hspace*{1em}\texttt{c += d; b \^{}= c; b} \verb|<<<|\texttt{= 12;} \\
\hspace*{1em}\texttt{a += b; d \^{}= a; d} \verb|<<<|\texttt{= 8;} \\
\hspace*{1em}\texttt{c += d; b \^{}= c; b} \verb|<<<|\texttt{= 7;} \\
\hspace*{1em}\texttt{return a, b, c, d}
\end{minipage}
\end{center}

I will call one row, consisting of one addition, one XOR and one shift operation, a \textit{quarterround step}. This naming convention will be reused in Section \ref{sec:userInterface}.

\section{Littleendian function}
\label{sec:chacha.littleendian}

The littleendian function takes in one 32-bit unsigned integer and reverses its byte order; also returning a 32-bit unsigned integer.  \\
It can be implemented as follows:

\begin{center}
\begin{minipage}{0.8\linewidth}
\texttt{littleendian(x):} \\
\hspace*{1em}\texttt{x0 = (x} \verb|>>|\texttt{ 24) \& 0xff;} \\
\hspace*{1em}\texttt{x1 = (x} \verb|>>|\texttt{ 16) \& 0xff;} \\
\hspace*{1em}\texttt{x2 = (x} \verb|>>|\texttt{ 8) \& 0xff;} \\
\hspace*{1em}\texttt{x3 = x \& 0xff;} \\
\hspace*{1em}\texttt{return (x3} \verb|<<|\texttt{ 24) | (x2 }\verb|<<|\texttt{ 16) | (x1 }\verb|<<|\texttt{ 8) | x0;}
\end{minipage}
\end{center}

\begin{remark}
Its naming has nothing to do with system endianness, but was just named like this by Prof. Bernstein for unknown reasons (most likely because reversing the byte order is what needs to be done when transmitting data between systems of different endianess).
\end{remark}

\section{ChaCha hash function}
\label{sec:chacha.hash}

The ChaCha hash function takes in 16 32-bit unsigned integers and returns 16 32-bit unsigned integers. The input vector $(y_0, y_1, y_2, \dots, y_{15})$ can be written as a 4$\times$4 matrix:

\begin{equation*}
\begin{pmatrix}
y_0 & y_1 & y_2 & y_3 \\
y_4 & y_5 & y_6 & y_7 \\
y_8 & y_9 & y_{10} & y_{11} \\
y_{12} & y_{13} & y_{14} & y_{15}\\
\end{pmatrix}
\end{equation*}

\noindent Using this matrix representation helps with understanding why Prof. Bernstein calls some rounds \textit{column rounds} and others \textit{diagonal rounds} in his paper (one round consists of four quarterrounds): \\
The ChaCha hash function iterates first through all columns and then through all diagonals of the matrix; applying the quarterround function to the four entries of each column/diagonal. After the first four quarterrounds it therefore has changed all columns of the matrix. This is what Prof. Bernstein calls a column round in his paper. After the next four quarterrounds, it changed all diagonals of the matrix which Prof. Bernstein analogously calls this a diagonal round.

\noindent To summarize, the following quarterrounds make up one column round:
\begin{center}
\begin{minipage}{0.5\linewidth}
\texttt{quarterround($y_0$, $y_4$, $y_8$, $y_{12}$)} \\
\texttt{quarterround($y_1$, $y_5$, $y_9$, $y_{13}$)} \\
\texttt{quarterround($y_2$, $y_6$, $y_{10}$, $y_{14}$)} \\
\texttt{quarterround($y_3$, $y_7$, $y_{11}$, $y_{15}$)} \\
\end{minipage}
\end{center}
\noindent whereas the following quarterrounds make up one diagonal round:
\begin{center}
\begin{minipage}{0.5\linewidth}
\texttt{quarterround($y_0$, $y_5$, $y_{10}$, $y_{15}$)} \\
\texttt{quarterround($y_1$, $y_6$, $y_{11}$, $y_{12}$)} \\
\texttt{quarterround($y_2$, $y_7$, $y_8$, $y_{13}$)} \\
\texttt{quarterround($y_3$, $y_4$, $y_9$, $y_{14}$)} \\
\end{minipage}
\end{center}

\noindent After a set amount of rounds (8, 12, or 20), the input vector is added to the vector on which the quarterround function was run. Then the byte order of each matrix entry is reversed using the littleendian function.

Having explained the basic structure of the ChaCha hash function, the following pseudo-code should complete the readers comprehension of it:

\begin{center}
\begin{minipage}{\linewidth}
\texttt{chachahash(y):} \\
\hspace*{1em}\texttt{z = copy(y);}\\
\hspace*{1em}\texttt{for(i = 0; i < ROUNDS; i += 2)}\\
\hspace*{2em}\texttt{// column round}\\
\hspace*{2em}\texttt{y[0], y[4], y[8], y[12] = quarterround(y[0], y[4], y[8], y[12]);}\\
\hspace*{2em}\texttt{y[1], y[5], y[9], y[13] = quarterround(y[1], y[5], y[9], y[13]);}\\
\hspace*{2em}\texttt{y[2], y[6], y[10], y[14] = quarterround(y[2], y[6], y[10], y[14]);}\\
\hspace*{2em}\texttt{y[3], y[7], y[11], y[15] = quarterround(y[3], y[7], y[11], y[15]);}\\
\hspace*{2em}\texttt{// diagonal round}\\
\hspace*{2em}\texttt{y[0], y[5], y[10], y[15] = quarterround(y[0], y[5], y[10], y[15]);}\\
\hspace*{2em}\texttt{y[1], y[6], y[11], y[12] = quarterround(y[0], y[5], y[10], y[15]);}\\
\hspace*{2em}\texttt{y[2], y[7], y[8], y[13] = quarterround(y[0], y[5], y[10], y[15]);}\\
\hspace*{2em}\texttt{y[3], y[4], y[9], y[14] = quarterround(y[0], y[5], y[10], y[15]);}\\
\hspace*{1em}\texttt{for(i = 0; i < 16; i += 1)}\\
\hspace*{2em}\texttt{y[i] += z[i];}\\
\hspace*{2em}\texttt{y[i] = littleendian(y[i]);}\\
\hspace*{1em}\texttt{return y;}
\end{minipage}
\end{center}

\section{ChaCha State Matrix}
\label{sec:chacha.matrix}